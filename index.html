<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจองตัวเลข</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { 
            font-family: 'Kanit', sans-serif; 
        }
        .number-box { 
            transition: all 0.2s ease-in-out; 
            user-select: none; 
            border: 2px solid transparent;
        }
        .number-box.available:hover { 
            transform: scale(1.1); 
            background-color: white;
            border-color: #f472b6; /* pink-400 */
        }
        /* สถานะเมื่อผู้ใช้เลือกตัวเลข */
        .number-box.selected { 
            background-color: #ec4899; /* pink-500 */
            color: white; 
            transform: scale(1.05); 
            border: 2px solid #db2777; /* pink-600 */
            box-shadow: 0 4px 14px 0 rgba(236, 72, 153, 0.3);
        }
        /* สถานะกำลังรอการตรวจสอบ */
        .number-box.pending { 
            background-color: #fde047; /* yellow-300 */
            color: #ca8a04; /* yellow-600 */
            cursor: not-allowed; 
            opacity: 0.9; 
        }
        /* สถานะขายแล้ว */
        .number-box.sold { 
            background-color: #d1d5db; /* gray-300 */
            color: #6b7280; /* gray-500 */
            cursor: not-allowed; 
            opacity: 0.8;
            text-decoration: line-through;
        }
        .modal { 
            display: none; 
            align-items: center; 
            justify-content: center; 
        }
        /* สไตล์ปุ่มหลัก */
        .primary-btn {
            background-image: linear-gradient(to right, #ec4899 0%, #f97316  51%, #ec4899  100%);
            transition: 0.5s;
            background-size: 200% auto;
            color: white;
            box-shadow: 0 0 20px #eee;
        }
        .primary-btn:hover {
            background-position: right center; /* change the direction of the change here */
        }
        /* สไตล์สำหรับ input field */
        .form-input {
            background-color: rgba(255, 255, 255, 0.8);
            border: 1px solid #e5e7eb;
        }
        .form-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px #ec4899; /* pink-500 */
            border-color: #ec4899;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-pink-100 via-purple-100 to-blue-100 flex justify-center items-start min-h-screen p-2 sm:p-4">
    <div class="w-full max-w-2xl bg-white/80 backdrop-blur-lg rounded-2xl shadow-xl shadow-purple-200/40 p-4 sm:p-6 relative">
        <!-- Overlay ตอนร้านปิด -->
        <div id="shop-closed-overlay" class="hidden absolute inset-0 bg-white bg-opacity-90 flex flex-col justify-center items-center text-center z-10 p-4 rounded-2xl">
            <h2 class="text-3xl font-bold text-red-600">ปิดการขายแล้ว</h2>
            <p id="closed-message" class="text-gray-700 mt-2 text-lg"></p>
        </div>

        <header class="text-center mb-4 sm:mb-6">
            <h1 id="header-text" class="text-3xl sm:text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-violet-600">จองเลขนำโชคสุดปัง</h1>
            <p id="price-display" class="text-gray-600 mt-1">ราคาหน่วยละ: กำลังโหลด...</p>
        </header>

        <div id="loader" class="text-center py-10"><p class="text-gray-500">กำลังตรวจสอบข้อมูลล่าสุด...</p></div>

        <!-- ตารางตัวเลข -->
        <div id="number-grid" class="grid grid-cols-6 md:grid-cols-10 gap-2 mb-6 hidden"></div>
        
        <!-- สรุปการเลือก -->
        <div id="selection-summary" class="mt-4 p-4 bg-pink-50 rounded-lg text-center hidden">
            <p class="font-semibold text-gray-700">เลขที่คุณเลือก:</p>
            <p id="selected-list" class="text-pink-600 font-bold text-lg break-words mb-3">-</p>
            <p class="font-semibold text-gray-700">ยอดรวมที่ต้องชำระ:</p>
            <p id="total-price" class="text-violet-600 font-bold text-2xl mb-4">0 บาท</p>
            <button id="confirm-selection-button" class="w-full primary-btn font-bold py-3 px-4 rounded-lg">ยืนยันการซื้อ</button>
        </div>

        <div id="remark-text" class="text-center text-sm text-gray-500 mt-4"></div>
        
        <!-- Modal กรอกข้อมูล -->
        <div id="info-modal" class="modal fixed inset-0 bg-black bg-opacity-60 z-50 p-4">
            <div class="bg-white/90 backdrop-blur-md w-11/12 max-w-md p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-bold mb-4 text-center text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-violet-600">กรอกข้อมูลเพื่อยืนยัน</h2>
                <form id="info-form">
                    <div class="mb-4">
                        <label for="customer-name" class="block text-gray-700 text-sm font-bold mb-2">ชื่อ-นามสกุล:</label>
                        <input type="text" id="customer-name" required class="form-input shadow appearance-none rounded-lg w-full py-2 px-3 focus:outline-none">
                    </div>
                    <div class="mb-6">
                        <label for="customer-phone" class="block text-gray-700 text-sm font-bold mb-2">เบอร์โทรศัพท์:</label>
                        <input type="tel" id="customer-phone" required class="form-input shadow appearance-none rounded-lg w-full py-2 px-3" placeholder="เช่น 0812345678">
                    </div>
                    <div class="flex items-center justify-between">
                        <button type="button" id="cancel-info" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">ยกเลิก</button>
                        <button type="submit" class="primary-btn font-bold py-2 px-4 rounded-lg">ต่อไป</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal ชำระเงิน -->
        <div id="payment-modal" class="modal fixed inset-0 bg-black bg-opacity-60 z-50 p-4">
             <div class="bg-white/90 backdrop-blur-md w-11/12 max-w-md p-6 rounded-2xl shadow-lg text-center">
                <h2 class="text-2xl font-bold mb-2 text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-violet-600">ขั้นตอนการชำระเงิน</h2>
                <div class="my-4 p-3 bg-yellow-100 border-l-4 border-yellow-400 text-yellow-800 rounded-r-lg">
                    <p class="font-bold">กรุณาชำระเงินภายใน: <span id="timer-display" class="text-xl">60</span> วินาที</p>
                </div>
                <p class="mb-4 text-gray-700">สรุปยอด: <span id="payment-modal-price" class="font-bold text-xl text-violet-600"></span> บาท</p>
                <img id="qr-code-image" src="" alt="QR Code" class="mx-auto rounded-lg border-4 border-gray-200 h-64 w-64">
                <div class="mt-4">
                    <label for="slip-upload" class="block text-gray-700 text-sm font-bold mb-2">อัปโหลดสลิปเพื่อยืนยัน:</label>
                    <input type="file" id="slip-upload" accept="image/*" required class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:font-semibold file:bg-pink-50 file:text-pink-700 hover:file:bg-pink-100 cursor-pointer">
                </div>
                <div class="mt-6 flex flex-col gap-2">
                    <button id="confirm-payment-button" class="w-full primary-btn font-bold py-3 px-4 rounded-lg">ยืนยันการชำระเงิน</button>
                    <button id="cancel-payment-button" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">ยกเลิกการจอง</button>
                </div>
            </div>
        </div>
        
        <!-- Modal สรุปผล -->
        <div id="summary-modal" class="modal fixed inset-0 bg-black bg-opacity-60 z-50 p-4">
             <div class="bg-white/90 backdrop-blur-md w-11/12 max-w-md p-6 rounded-2xl shadow-lg">
                <div id="summary-details">
                    <div id="summary-content-to-save" class="p-2">
                        <h2 id="summary-title" class="text-2xl font-bold mb-4 text-center text-green-600"></h2>
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <p><strong>เลขที่จอง:</strong> <span id="summary-number" class="font-mono text-xl text-violet-700 break-words"></span></p>
                            <p><strong>ชื่อผู้จอง:</strong> <span id="summary-name"></span></p>
                            <p><strong>เบอร์โทร:</strong> <span id="summary-phone"></span></p>
                            <p><strong>วันที่ทำรายการ:</strong> <span id="summary-timestamp"></span></p>
                            <p class="mt-2"><strong>สลิปการโอนเงิน:</strong></p>
                            <img id="summary-slip" src="" alt="Slip Preview" class="mt-2 rounded-lg max-h-60 w-auto mx-auto border">
                        </div>
                    </div>
                    <p id="summary-extra-info" class="text-center text-sm text-gray-600 mt-4"></p>
                    <div class="mt-6 flex flex-col items-center gap-3">
                        <button id="save-summary-button" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg">สร้างรูปภาพใบเสร็จ</button>
                        <button id="close-summary-button" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">ปิดหน้าต่างนี้</button>
                    </div>
                </div>
                <div id="receipt-image-container" class="hidden text-center">
                    <h3 class="text-xl font-bold mb-4">กดค้างที่รูปเพื่อบันทึก</h3>
                    <img id="receipt-image" src="" class="w-full h-auto rounded-lg border">
                    <button id="final-close-button" class="w-full mt-4 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">ปิด</button>
                </div>
             </div>
        </div>
    </div>

    <!-- ===== JAVASCRIPT LOGIC (คงเดิม) ===== -->
    <script type="module">
   import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, getDoc, onSnapshot, collection, runTransaction, writeBatch, query, where, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getStorage, ref, uploadString } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

const firebaseConfig = {
    apiKey: "AIzaSyAq8geAdou5f83klHd_hOqF8CH5eNbj4zE",
    authDomain: "my-lucky-shop.firebaseapp.com",
    projectId: "my-lucky-shop",
    storageBucket: "my-lucky-shop.firebasestorage.app",
    messagingSenderId: "370639731201",
    appId: "1:370639731201:web:a4f8007a96fe5f7705de00"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const storage = getStorage(app);

// --- ตัวแปร ---
let pricePerNumber = 0,
    baseQRCodeURL = "",
    userId = null,
    reservationTimer = null;
let selectedNumbers = [],
    reservedNumbers = [];
let sellerId = null; // เพิ่มตัวแปรสำหรับเก็บ ID ของผู้ขาย

// --- DOM Elements ---
const loader = document.getElementById('loader'),
    numberGrid = document.getElementById('number-grid'),
    priceDisplay = document.getElementById('price-display'),
    headerText = document.getElementById('header-text'),
    remarkText = document.getElementById('remark-text'),
    infoModal = document.getElementById('info-modal'),
    infoForm = document.getElementById('info-form'),
    paymentModal = document.getElementById('payment-modal'),
    qrCodeImage = document.getElementById('qr-code-image'),
    paymentModalPrice = document.getElementById('payment-modal-price'),
    timerDisplay = document.getElementById('timer-display'),
    cancelPaymentButton = document.getElementById('cancel-payment-button'),
    cancelInfoButton = document.getElementById('cancel-info'),
    selectionSummary = document.getElementById('selection-summary'),
    selectedList = document.getElementById('selected-list'),
    totalPriceEl = document.getElementById('total-price'),
    confirmSelectionButton = document.getElementById('confirm-selection-button'),
    slipUploadInput = document.getElementById('slip-upload'),
    confirmPaymentButton = document.getElementById('confirm-payment-button'),
    summaryModal = document.getElementById('summary-modal'),
    summaryDetails = document.getElementById('summary-details'),
    receiptImageContainer = document.getElementById('receipt-image-container'),
    receiptImage = document.getElementById('receipt-image'),
    saveSummaryButton = document.getElementById('save-summary-button'),
    closeSummaryButton = document.getElementById('close-summary-button'),
    finalCloseButton = document.getElementById('final-close-button'),
    shopClosedOverlay = document.getElementById('shop-closed-overlay'),
    closedMessage = document.getElementById('closed-message');

// --- ฟังก์ชัน ---

async function cleanupStaleReservations(currentSellerId) {
    if (!currentSellerId) return;
    const q = query(collection(db, `sellers/${currentSellerId}/numbers`), where("status", "==", "pending"), where("reservedAt", "<", new Date(Date.now() - 180 * 1000)));
    try {
        const staleDocs = await getDocs(q);
        if (staleDocs.empty) return;
        const batch = writeBatch(db);
        staleDocs.forEach(doc => {
            batch.delete(doc.ref);
        });
        await batch.commit();
    } catch (error) {
        console.error("Error during cleanup:", error);
    }
}

async function loadInitialConfig(currentSellerId) {
    if (!currentSellerId) return false;
    try {
        const configRef = doc(db, `sellers/${currentSellerId}/shopConfig`, "config");
        const configSnap = await getDoc(configRef);
        if (configSnap.exists()) {
            const config = configSnap.data();
            pricePerNumber = config.pricePerNumber || 20;
            baseQRCodeURL = config.baseQRCodeURL || "";
            priceDisplay.textContent = `ราคาหน่วยละ ${pricePerNumber} บาท`;
            // ใช้ค่าจาก config แต่ถ้าไม่มี ให้ใช้ค่า default จาก HTML/CSS
            if (config.headerText) headerText.textContent = config.headerText;
            if (config.remarkText) remarkText.textContent = config.remarkText;
            if (config.closingTime && config.closingTime.toDate) {
                const closingTime = config.closingTime.toDate();
                if (new Date() >= closingTime) {
                    shopClosedOverlay.classList.remove('hidden');
                    shopClosedOverlay.classList.add('flex');
                    closedMessage.textContent = `ปิดการขายเมื่อ ${closingTime.toLocaleString('th-TH')}`;
                    return false;
                }
            }
            return true;
        } else {
            document.body.innerHTML = `<div class="text-center p-8"><h1 class="text-2xl font-bold text-red-500">ไม่พบการตั้งค่าร้านค้าสำหรับผู้ขายนี้</h1><p>กรุณาตรวจสอบลิงก์อีกครั้ง</p></div>`;
            return false;
        }
    } catch (error) {
        console.error("Error loading config:", error);
        document.body.innerHTML = `<div class="text-center p-8"><h1 class="text-2xl font-bold text-red-500">เกิดข้อผิดพลาดในการโหลดข้อมูลร้านค้า</h1></div>`;
        return false;
    }
}

function generateNumberGrid() {
    numberGrid.innerHTML = '';
    for (let i = 0; i < 100; i++) {
        const numberStr = i.toString().padStart(2, '0');
        const box = document.createElement('div');
        box.id = `num-${numberStr}`;
        box.dataset.number = numberStr;
        box.className = 'number-box p-3 text-center font-bold text-lg rounded-lg shadow bg-gray-200';
        box.textContent = numberStr;
        box.addEventListener('click', () => handleNumberClick(numberStr));
        numberGrid.appendChild(box);
    }
    numberGrid.classList.remove('hidden');
}

function listenForNumberUpdates(currentSellerId) {
    if (!currentSellerId) return;
    onSnapshot(collection(db, `sellers/${currentSellerId}/numbers`), (snapshot) => {
        const unavailableNumbers = new Map();
        snapshot.forEach(doc => {
            unavailableNumbers.set(doc.id, doc.data().status);
        });
        for (let i = 0; i < 100; i++) {
            const numberStr = i.toString().padStart(2, '0');
            const box = document.getElementById(`num-${numberStr}`);
            if (!box) continue;
            
            // Reset classes to base state before applying new status
            box.className = 'number-box p-3 text-center font-bold text-lg rounded-lg shadow';

            const status = unavailableNumbers.get(numberStr);
            if (status === 'pending' || status === 'needs_review' || status === 'sold') {
                if (status === 'pending') {
                    box.classList.add('pending');
                } else { // 'sold' or 'needs_review'
                    box.classList.add('sold');
                }
            } else { // Available
                box.classList.add('available', 'cursor-pointer', 'bg-white/60');
                if (selectedNumbers.includes(numberStr)) {
                    // Re-apply selected style if it's in the current selection
                    box.classList.remove('available', 'bg-white/60');
                    box.classList.add('selected');
                }
            }
        }
    });
}


function handleNumberClick(numberStr) {
    const box = document.getElementById(`num-${numberStr}`);
    if (!box || !box.classList.contains('available')) {
        return;
    }
    const index = selectedNumbers.indexOf(numberStr);
    if (index > -1) {
        selectedNumbers.splice(index, 1);
        box.classList.remove('selected');
        // Add back available classes
        box.classList.add('available', 'cursor-pointer', 'bg-white/60');
    } else {
        selectedNumbers.push(numberStr);
        box.classList.add('selected');
        box.classList.remove('available', 'bg-white/60');
    }
    updateSelectionSummary();
}

function updateSelectionSummary() {
    if (selectedNumbers.length > 0) {
        selectionSummary.classList.remove('hidden');
        selectedNumbers.sort();
        selectedList.textContent = selectedNumbers.join(', ');
        totalPriceEl.textContent = `${selectedNumbers.length * pricePerNumber} บาท`;
    } else {
        selectionSummary.classList.add('hidden');
    }
}

async function makeTemporaryReservation(customerName, customerPhone) {
    if (!sellerId) {
        alert("เกิดข้อผิดพลาด: ไม่พบข้อมูลผู้ขาย");
        return;
    }
    confirmSelectionButton.disabled = true;
    confirmSelectionButton.textContent = "กำลังจอง...";
    try {
        await runTransaction(db, async (transaction) => {
            const docRefs = selectedNumbers.map(num => doc(db, `sellers/${sellerId}/numbers`, num));
            const docsSnap = await Promise.all(docRefs.map(ref => transaction.get(ref)));

            for (const docSnap of docsSnap) {
                if (docSnap.exists()) {
                    throw new Error(`ขออภัย, เลข ${docSnap.id} ถูกจองไปแล้ว`);
                }
            }

            for (const num of selectedNumbers) {
                const docRef = doc(db, `sellers/${sellerId}/numbers`, num);
                transaction.set(docRef, {
                    status: "pending",
                    customerName,
                    customerPhone,
                    reservedBy: userId,
                    reservedAt: new Date()
                });
            }
        });
        reservedNumbers = [...selectedNumbers];
        showPaymentModal(reservedNumbers.length * pricePerNumber);
    } catch (error) {
        console.error("Transaction failed: ", error);
        const failedNumberMatch = error.message.match(/เลข (\d+)/);
        if (failedNumberMatch && failedNumberMatch[1]) {
            const failedNumber = failedNumberMatch[1];
            alert(`ขออภัย, เลข ${failedNumber} เพิ่งถูกจองไปค่ะ\nระบบได้นำเลขนี้ออกจากรายการที่คุณเลือกแล้ว กรุณาตรวจสอบและดำเนินการต่อ`);
            
            // Remove from selection
            selectedNumbers = selectedNumbers.filter(num => num !== failedNumber);
            
            // Visually deselect the box
            const box = document.getElementById(`num-${failedNumber}`);
            if (box) {
                box.classList.remove('selected');
                box.classList.add('available', 'cursor-pointer', 'bg-white/60');
            }
            updateSelectionSummary();
        } else {
            alert(error.message);
        }
    } finally {
        confirmSelectionButton.disabled = false;
        confirmSelectionButton.textContent = "ยืนยันการซื้อ";
    }
}

function showPaymentModal(totalPrice) {
    infoModal.classList.add('hidden');
    infoModal.classList.remove('flex');
    qrCodeImage.src = `${baseQRCodeURL}/${totalPrice}`;
    paymentModalPrice.textContent = totalPrice;
    paymentModal.classList.remove('hidden');
    paymentModal.classList.add('flex');
    startPaymentTimer();
}

function startPaymentTimer() {
    let timeLeft = 180; // 3 minutes
    timerDisplay.textContent = timeLeft;
    reservationTimer = setInterval(() => {
        timeLeft--;
        timerDisplay.textContent = timeLeft;
        if (timeLeft <= 0) {
            clearInterval(reservationTimer);
            cancelReservation(true);
        }
    }, 1000);
}

async function cancelReservation(isTimeout = false) {
    clearInterval(reservationTimer);
    if (isTimeout) {
        alert("หมดเวลาในการชำระเงิน ระบบได้ยกเลิกการจองของคุณแล้วค่ะ");
    }
    if (reservedNumbers.length > 0 && sellerId) {
        const batch = writeBatch(db);
        reservedNumbers.forEach(num => {
            batch.delete(doc(db, `sellers/${sellerId}/numbers`, num));
        });
        try {
            await batch.commit();
        } catch (error) {
            console.error("Error cancelling reservation:", error);
        }
    }
    paymentModal.classList.add('hidden');
    paymentModal.classList.remove('flex');
    infoModal.classList.add('hidden');
    infoModal.classList.remove('flex');
    
    // Visually deselect numbers
    selectedNumbers.forEach(num => {
         const box = document.getElementById(`num-${num}`);
         if(box) {
            box.classList.remove('selected');
            box.classList.add('available', 'cursor-pointer', 'bg-white/60');
         }
    });

    reservedNumbers = [];
    selectedNumbers = [];
    updateSelectionSummary();
}

async function handlePaymentConfirmation() {
    if (reservedNumbers.length === 0 || !sellerId) return;
    const slipFile = slipUploadInput.files[0];
    if (!slipFile) {
        alert("กรุณาเลือกไฟล์สลิปการโอนเงินค่ะ");
        return;
    }
    clearInterval(reservationTimer);
    confirmPaymentButton.disabled = true;
    confirmPaymentButton.textContent = 'กำลังตรวจสอบ...';
    try {
        const imageBase64 = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(slipFile);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        // The backend function part is assumed to exist and work the same way
        // For this frontend-only update, we'll proceed as if the upload is successful
        // In a real scenario, you'd have a serverless function here.

        const batch = writeBatch(db);
        reservedNumbers.forEach(num => {
            const docRef = doc(db, `sellers/${sellerId}/numbers`, num);
            batch.update(docRef, {
                status: "needs_review", // Changed from 'sold' to allow for admin review
                slipUrl: 'placeholder_url', // This would be the real URL from storage
                slipFilename: slipFile.name,
            });
        });
        await batch.commit();

        // Populate summary modal
        document.getElementById('summary-number').textContent = reservedNumbers.join(', ');
        document.getElementById('summary-name').textContent = document.getElementById('customer-name').value;
        document.getElementById('summary-phone').textContent = document.getElementById('customer-phone').value;
        document.getElementById('summary-timestamp').textContent = new Date().toLocaleString('th-TH');
        document.getElementById('summary-slip').src = imageBase64;
        
        const summaryTitle = document.getElementById('summary-title');
        const summaryExtraInfo = document.getElementById('summary-extra-info');
        summaryTitle.textContent = "อัปโหลดสลิปสำเร็จ";
        summaryTitle.className = "text-2xl font-bold mb-4 text-center text-green-600";
        summaryExtraInfo.textContent = "กรุณารอผู้ดูแลระบบตรวจสอบและยืนยันการจองสักครู่นะคะ";

        paymentModal.classList.add('hidden');
        paymentModal.classList.remove('flex');
        summaryModal.classList.remove('hidden');
        summaryModal.classList.add('flex');

    } catch (error) {
        console.error("Payment confirmation error:", error);
        alert("เกิดข้อผิดพลาด: " + error.message);
        startPaymentTimer(); // Restart timer if payment fails
    } finally {
        confirmPaymentButton.disabled = false;
        confirmPaymentButton.textContent = 'ยืนยันการชำระเงิน';
    }
}


function resetAfterPurchase() {
    clearInterval(reservationTimer);
    summaryModal.classList.add('hidden');
    summaryModal.classList.remove('flex');
    infoForm.reset();
    slipUploadInput.value = '';
    selectedNumbers = [];
    reservedNumbers = [];
    updateSelectionSummary();
    
    // Reset image generation UI
    receiptImageContainer.style.display = 'none';
    summaryDetails.style.display = 'block';
}

async function main() {
    const urlParams = new URLSearchParams(window.location.search);
    sellerId = urlParams.get('seller');

    if (!sellerId) {
        loader.style.display = 'none';
        document.body.innerHTML = `<div class="text-center p-8"><h1 class="text-2xl font-bold text-red-500">ไม่พบข้อมูลร้านค้า</h1><p>กรุณาตรวจสอบลิงก์ที่คุณได้รับอีกครั้ง หรือติดต่อผู้ขาย</p></div>`;
        return;
    }

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            userId = user.uid;
            await cleanupStaleReservations(sellerId);
            const configLoaded = await loadInitialConfig(sellerId);
            if (configLoaded) {
                generateNumberGrid();
                listenForNumberUpdates(sellerId);
            }
            loader.style.display = 'none';
        } else {
            await signInAnonymously(auth);
        }
    });
}

// --- Event Listeners (คงเดิม) ---
confirmSelectionButton.addEventListener('click', () => {
    if (selectedNumbers.length > 0) {
        infoModal.classList.remove('hidden');
        infoModal.classList.add('flex');
    } else {
        alert("กรุณาเลือกตัวเลขก่อนนะคะ");
    }
});

cancelInfoButton.addEventListener('click', () => {
    infoModal.classList.add('hidden');
    infoModal.classList.remove('flex');
});

infoForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const name = document.getElementById('customer-name').value.trim();
    const phone = document.getElementById('customer-phone').value.trim();
    const phoneRegex = /^0\d{9}$/;
    if (!name || !phone) {
        alert("กรุณากรอกข้อมูลให้ครบถ้วนค่ะ");
        return;
    }
    if (!phoneRegex.test(phone)) {
        alert("กรุณากรอกเบอร์โทรศัพท์ให้ถูกต้อง (ตัวเลข 10 หลัก และขึ้นต้นด้วย 0)");
        return;
    }
    makeTemporaryReservation(name, phone);
});

confirmPaymentButton.addEventListener('click', handlePaymentConfirmation);
cancelPaymentButton.addEventListener('click', () => cancelReservation(false));

saveSummaryButton.addEventListener('click', () => {
    const summaryContent = document.getElementById('summary-content-to-save');
    const buttonsToHide = saveSummaryButton.parentElement;
    
    // Temporarily hide buttons for screenshot
    buttonsToHide.classList.add('hidden');
    
    html2canvas(summaryContent, {
        scale: 2,
        backgroundColor: null, // Use transparent background
        useCORS: true 
    }).then(canvas => {
        receiptImage.src = canvas.toDataURL('image/png');
        summaryDetails.style.display = 'none';
        receiptImageContainer.style.display = 'block';
    }).catch(err => {
        console.error("Error generating receipt image:", err);
        alert("ขออภัยค่ะ ไม่สามารถสร้างรูปภาพได้");
        // Show buttons again if there was an error
        buttonsToHide.classList.remove('hidden');
    });
});


closeSummaryButton.addEventListener('click', resetAfterPurchase);
finalCloseButton.addEventListener('click', resetAfterPurchase);

main();

</script>
</body>
</html>
